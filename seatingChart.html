<!DOCTYPE html>
<html>

<head>
    <title>Seating Chart</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="bootstrap/open-iconic.css" type="text/css">
    <script type="text/javascript" src="jquery/jquery-3.2.1.slim.min.js"></script>
    <script type="text/javascript" src="bootstrap/popper.min.js"></script>
    <script type="text/javascript" src="bootstrap/bootstrap.min.js"></script>
    <link rel="stylesheet" href="multi-select/bootstrap-multiselect.css" type="text/css" />
    <script type="text/javascript" src="multi-select/bootstrap-multiselect.js"></script>
    <style>
        /* Use a Flexbox to make the Palette/Diagram responsive */
        #myFlexDiv {
            display: -webkit-flex;
            display: flex;
            flex-flow: row wrap;
            width: 100%;
            justify-content: center;
        }

        @media (min-width: 768px) {
            #myGuests {
                width: 100px;
                height: 500px;
                margin-right: 10px;
            }

            #myDiagramDiv {
                height: 600px;
                flex: 1;
            }
        }

        @media (max-width: 767px) {
            #myGuests {
                width: 90%;
                height: 100px;
                margin-bottom: 10px;
            }

            #myDiagramDiv {
                width: 90%;
                height: 500px;
            }
        }
        
        .required-label{
            color: red;
        }
        
        .required-border{
            border-color: red;
        }
    </style>
    <script src="go.js"></script>
</head>

<body>
    <div id="sample">
        <div id="myFlexDiv">
            <div id="myGuests" style="border: solid 1px black; display: none"></div>

            <div id="myDiagramDiv" style="border: solid 1px black"></div>
        </div>
        <div>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createTableModal" onclick="showCreateRowModal()">
                Create Line
            </button>
            <button type="button" class="btn btn-warning" data-toggle="modal" onclick="DeleteLine()">
                Delete Line
            </button>
            <button type="button" class="btn btn-success" onclick="AddSeat()">
                Add Seat
            </button>
            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delSeatModal" onclick="openDelSeatModal()">
                Remove Seat
            </button>
        </div>

        <div>
            Diagram Model saved in JSON format, automatically updated after each transaction:
            <pre id="savedModel" style="height:250px"></pre>
        </div>
    </div>

    <!-- Creating Table Modal -->
    <div class="modal fade" id="createTableModal" tabindex="-1" role="dialog" aria-labelledby="lbCreateTbModal" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lbCreateTbModal">Create table</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <!--                <form>-->
                <div class="modal-body">
                    <div class="form-group row">
                        <label for="lineName" class="col-sm-2">Line Name<span class="required-label">*</span></label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control required-border" id="lineName" placeholder="Line Name" onchange="validateInput(this);" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange()">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="seatTotal" class="col-sm-2">Seat Total<span class="required-label">*</span></label>
                        <div class="col-sm-4">
                            <input type="number" min="1" class="form-control required-border" id="seatTotal" placeholder="Seat Total" onchange="validateNumber(this);" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange()">
                        </div>
                        <label for="grSeatDis" class="col-sm-3" style="text-align: right">Seat Distance<span class="required-label">*</span></label>
                        <div class="input-group col-sm-3" id="grSeatDis">
                            <input type="number" min="1" class="form-control required-border" id="seatDis" placeholder="Seat Distance" aria-label="Seat Distance" placeholder="Seat Distance" onchange="validateNumber(this);" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange()">
                            <div class="input-group-append">
                                <span class="input-group-text">pixel</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="seatType" class="col-sm-3">Seat Type<span class="required-label">*</span></label>
                        <div class="col-sm-9" id="seatType">
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdTwoSidesTop" name="seatType" class="custom-control-input" value="1">
                                <label class="custom-control-label" for="rdTwoSidesTop">
                                    <img src="images/seat-direction-top.PNG" alt="seating direction top">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdTwoSidesBottom" name="seatType" class="custom-control-input" value="2">
                                <label class="custom-control-label" for="rdTwoSidesBottom">
                                    <img src="images/seat-direction-bottom.PNG" alt="seating direction bottom">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdOneSideTop" name="seatType" class="custom-control-input" value="3">
                                <label class="custom-control-label" for="rdOneSideTop">
                                    <img src="images/seat-one-side-top.PNG" alt="seating one side top">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdOneSideBottom" name="seatType" class="custom-control-input" value="4">
                                <label class="custom-control-label" for="rdOneSideBottom">
                                    <img src="images/seat-one-side-bottom.PNG" alt="seating one side bottom">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdOneSideTopOdd" name="seatType" class="custom-control-input" value="5">
                                <label class="custom-control-label" for="rdOneSideTopOdd">
                                    <img src="images/seat-one-side-top-odd.PNG" alt="seating one side odd top">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdOneSideBottomOdd" name="seatType" class="custom-control-input" value="6">
                                <label class="custom-control-label" for="rdOneSideBottomOdd">
                                    <img src="images/seat-one-side-bottom-odd.PNG" alt="seating one side bottom even">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdOneSideTopEven" name="seatType" class="custom-control-input" value="7">
                                <label class="custom-control-label" for="rdOneSideTopEven">
                                    <img src="images/seat-one-side-top-even.PNG" alt="seating one side even top">
                                </label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline">
                                <input type="radio" id="rdOneSideBottomEven" name="seatType" class="custom-control-input" value="8">
                                <label class="custom-control-label" for="rdOneSideBottomEven">
                                    <img src="images/seat-one-side-bottom-even.PNG" alt="seating one side even bottom">
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="lineName" class="col-sm-3">Background Color</label>
                        <div class="col-sm-9">
                            <input type="color" id="bgColorRow" style="height: 35px; width: 55px;" value="#deb887">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="grWidth" class="col-sm-2">Width<span class="required-label">*</span></label>
                        <div class="input-group col-sm-3" id="grWidth">
                            <input type="number" min="1" class="form-control required-border" id="tableWidth" aria-label="Virtual Width" placeholder="Virtual Width" onchange="validateNumber(this);" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange()">
                            <div class="input-group-append">
                                <span class="input-group-text">pixel</span>
                            </div>
                        </div>
                        <div class="custom-control custom-checkbox col-sm-1">
                            <input type="checkbox" class="custom-control-input" id="cbCalculateWidth" onchange="calculateTableWidth(this)">
                            <label class="custom-control-label" for="cbCalculateWidth" title="Based on seat total"></label>
                        </div>

                        <label for="grHeight" class="col-sm-2" style="text-align: right">Height<span class="required-label">*</span></label>
                        <div class="input-group col-sm-4" id="grHeight">
                            <input type="number" min="1" class="form-control required-border" id="tableHeight" aria-label="Virtual Height" placeholder="Virtual Height" onchange="validateNumber(this);" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange()">
                            <div class="input-group-append">
                                <span class="input-group-text">pixel</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="grActualWidth" class="col-sm-2">Actual Width</label>
                        <div class="input-group col-sm-4" id="grActualWidth">
                            <input type="number" min="1" class="form-control" id="tableActualWidth" aria-label="Actual Width" placeholder="Actual Width">
                            <div class="input-group-append">
                                <span class="input-group-text">meter</span>
                            </div>
                        </div>

                        <label for="grActualHeight" class="col-sm-2" style="text-align: right">Actual Height</label>
                        <div class="input-group col-sm-4" id="grActualHeight">
                            <input type="number" min="1" class="form-control" id="tableActualHeight" aria-label="Actual Height">
                            <div class="input-group-append">
                                <span class="input-group-text">meter</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createTable()">Create</button>
                </div>
                <!--                </form>-->
            </div>
        </div>
    </div>

    <!-- Deleting Seat of Table Modal -->
    <div class="modal fade" id="delSeatModal" tabindex="-1" role="dialog" aria-labelledby="lbDelSeatModal" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lbDelSeatModal">Delete Seats</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <!--                <form>-->
                <div class="modal-body">
                    <div class="form-group row">
                        <div class="col-sm-12">
                            <label for="selSeat" class="col-form-label">Select specified seats</label>
                            <select id="selSeat" multiple="multiple"></select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="delSeat()">Delete</button>
                </div>
                <!--                </form>-->
            </div>
        </div>
    </div>
</body>

<script>
    var goJs = go.GraphObject.make;
    var myDiagram;

    function tableStyle() {
        return [{
                background: "transparent"
            },
            {
                layerName: "Background"
            }, // behind all Persons
            {
                locationSpot: go.Spot.Center,
                locationObjectName: "TABLESHAPE"
            },
            new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
            {
                rotatable: true
            },
            new go.Binding("angle").makeTwoWay(),
            { // what to do when a drag-over or a drag-drop occurs on a Node representing a table
                mouseDragEnter: function(e, node, prev) {
                    highlightSeats(node, node.diagram.selection, true);
                },
                mouseDragLeave: function(e, node, next) {
                    highlightSeats(node, node.diagram.selection, false);
                },
                mouseDrop: function(e, node) {
                    assignPeopleToSeats(node, node.diagram.selection, e.documentPoint);

                    console.log('mouse drop');
                }
            }
        ];
    }

    // Create a seat element at a particular alignment relative to the table.
    function Seat(number, align, focus, bgColor) {
        if (bgColor === null || bgColor === undefined) bgColor = "burlywood";
        if (typeof align === 'string') align = go.Spot.parse(align);
        if (!align || !align.isSpot()) align = go.Spot.Right;
        if (typeof focus === 'string') focus = go.Spot.parse(focus);
        if (!focus || !focus.isSpot()) focus = align.opposite();
        return goJs(go.Panel, "Spot", {
                name: number.toString(),
                alignment: align,
                alignmentFocus: focus
            },
            goJs(go.Shape, "Circle", {
                    name: "SEATSHAPE",
                    desiredSize: new go.Size(35, 35),
                    fill: bgColor,
                    stroke: "white",
                    strokeWidth: 2
                },
                new go.Binding("fill")),
            goJs(go.TextBlock, number.toString(), {
                    font: "10pt Verdana, sans-serif"
                },
                new go.Binding("angle", "angle", function(n) {
                    console.log(n);
                    return -n;
                }))
        );
    }

    function initData() {
        // Initialize the main Diagram
        myDiagram = goJs(go.Diagram, "myDiagramDiv", {
            allowDragOut: true, // to myGuests
            allowDrop: true, // from myGuests
            allowClipboard: false,
            initialContentAlignment: go.Spot.Center,
            draggingTool: goJs(SpecialDraggingTool),
            rotatingTool: goJs(HorizontalTextRotatingTool),
            // For this sample, automatically show the state of the diagram's model on the page
            "ModelChanged": function(e) {
                if (e.isTransactionFinished) {
                    document.getElementById("savedModel").textContent = myDiagram.model.toJson();
                }
            },
            "undoManager.isEnabled": true
        });

        myDiagram.nodeTemplateMap.add("", // default template, for people
            goJs(go.Node, "Auto", {
                    background: "transparent"
                }, // in front of all Tables
                // when selected is in foreground layer
                new go.Binding("layerName", "isSelected", function(s) {
                    return s ? "Foreground" : "";
                }).ofObject(), {
                    locationSpot: go.Spot.Center
                },
                new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                new go.Binding("text", "key"), { // what to do when a drag-over or a drag-drop occurs on a Node representing a table
                    mouseDragEnter: function(e, node, prev) {
                        highlightSeats(node, node.diagram.selection, true);
                    },
                    mouseDragLeave: function(e, node, next) {
                        highlightSeats(node, node.diagram.selection, false);
                    },
                    mouseDrop: function(e, node) {
                        assignPeopleToSeats(node, node.diagram.selection, e.documentPoint);

                        console.log("this drop of node event");
                    }
                },
                goJs(go.Shape, "Rectangle", {
                    fill: "blanchedalmond",
                    stroke: null
                }),
                goJs(go.Panel, "Viewbox", {
                        desiredSize: new go.Size(50, 38)
                    },
                    goJs(go.TextBlock, {
                            margin: 2,
                            desiredSize: new go.Size(55, NaN),
                            font: "8pt Verdana, sans-serif",
                            textAlign: "center",
                            stroke: "darkblue"
                        },
                        new go.Binding("text", "", function(data) {
                            var s = data.key;
                            if (data.plus) s += " +" + data.plus.toString();
                            return s;
                        }))
                )
            ));

        myDiagram.nodeTemplateMap.add("TableC8", // circular with 8 seats
            goJs(go.Node, "Spot", tableStyle(),
                goJs(go.Panel, "Spot",
                    goJs(go.Shape, "Circle", {
                            name: "TABLESHAPE",
                            desiredSize: new go.Size(120, 120),
                            fill: "burlywood",
                            stroke: null
                        },
                        new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),
                        new go.Binding("fill")),
                    goJs(go.TextBlock, {
                            editable: true,
                            font: "bold 11pt Verdana, sans-serif"
                        },
                        new go.Binding("text", "name").makeTwoWay(),
                        new go.Binding("angle", "angle", function(n) {
                            return -n;
                        })
                    )
                ),
                Seat(1, "0.50 0", "0.5 1"),
                Seat(2, "0.85 0.15", "0.15 0.85"),
                Seat(3, "1 0.5", "0 0.5"),
                Seat(4, "0.85 0.85", "0.15 0.15"),
                Seat(5, "0.50 1", "0.5 0"),
                Seat(6, "0.15 0.85", "0.85 0.15"),
                Seat(7, "0 0.5", "1 0.5"),
                Seat(8, "0.15 0.15", "0.85 0.85")
            ));

        // what to do when a drag-drop occurs in the Diagram's background
        myDiagram.mouseDrop = function(e) {
            // when the selection is dropped in the diagram's background,
            // make sure the selected people no longer belong to any table
            e.diagram.selection.each(function(n) {
                if (isPerson(n)) unassignSeat(n.data);
            });

            console.log('mouse drop Diagram`s background');
        };

        myDiagram.doubleClick = (e) => {
            console.log(e);
        };

        // to simulate a "move" from the Palette, the source Node must be deleted.
        myDiagram.addDiagramListener("ExternalObjectsDropped", function(e) {
            // if any Tables were dropped, don't delete from myGuests
            if (!e.subject.any(isTable)) {
                myGuests.commandHandler.deleteSelection();
            }

            console.log("ExternalObjectsDropped........");
        });

        // put deleted people back in the myGuests diagram
        myDiagram.addDiagramListener("SelectionDeleted", function(e) {
            // no-op if deleted by myGuests' ExternalObjectsDropped listener
            if (myDiagram.disableSelectionDeleted) return;
            // e.subject is the myDiagram.selection collection
            e.subject.each(function(n) {
                if (isPerson(n)) {
                    myGuests.model.addNodeData(myGuests.model.copyNodeData(n.data));
                }
            });
        });

        // initialize the Palette
        myGuests = goJs(go.Diagram, "myGuests", {
            layout: goJs(go.GridLayout, {
                sorting: go.GridLayout.Ascending // sort by Node.text value
            }),
            allowDragOut: true, // to myDiagram
            allowDrop: true // from myDiagram
        });

        myGuests.nodeTemplateMap = myDiagram.nodeTemplateMap;

        // specify the contents of the Palette
        myGuests.model = new go.GraphLinksModel([{
                key: "Nguyễn Xuân Hoàng"
            },
            {
                key: "Nguyễn Cao Sơn"
            },
            {
                key: "Lê Hữu Tài"
            },
            {
                key: "Nguyễn Thị Ngọc Hà"
            },
            {
                key: "Nguyễn Thị Ngọc Hương"
            },
            {
                key: "Naveen"
            }
        ]);

        myGuests.model.undoManager = myDiagram.model.undoManager // shared UndoManager!

        // To simulate a "move" from the Diagram back to the Palette, the source Node must be deleted.
        myGuests.addDiagramListener("ExternalObjectsDropped", function(e) {
            // e.subject is the myGuests.selection collection
            // if the user dragged a Table to the myGuests diagram, cancel the drag
            if (e.subject.any(isTable)) {
                myDiagram.currentTool.doCancel();
                myGuests.currentTool.doCancel();
                return;
            }
            myDiagram.selection.each(function(n) {
                if (isPerson(n)) unassignSeat(n.data);
            });
            myDiagram.disableSelectionDeleted = true;
            myDiagram.commandHandler.deleteSelection();
            myDiagram.disableSelectionDeleted = false;
            myGuests.selection.each(function(n) {
                if (isPerson(n)) unassignSeat(n.data);
            });
        });
    }
    // end init

    function isPerson(n) {
        return n !== null && n.category === "";
    }

    function isTable(n) {
        return n !== null && n.category !== "";
    }

    // Highlight the empty and occupied seats at a "Table" Node
    function highlightSeats(node, coll, show) {
        if (isPerson(node)) { // refer to the person's table instead
            node = node.diagram.findNodeForKey(node.data.table);
            if (node === null) return;
        }
        if (coll.any(isTable)) {
            // if dragging a Table, don't do any highlighting
            return;
        }
        var guests = node.data.guests;
        for (var sit = node.elements; sit.next();) {
            var seat = sit.value;
            if (seat.name) {
                var num = parseFloat(seat.name);
                if (isNaN(num)) continue;
                var seatshape = seat.findObject("SEATSHAPE");
                if (!seatshape) continue;
                if (show) {
                    if (guests[seat.name]) {
                        seatshape.stroke = "red";
                    } else {
                        seatshape.stroke = "green";
                    }
                } else {
                    seatshape.stroke = "white";
                }
            }
        }
    }

    // Given a "Table" Node, assign seats for all of the people in the given collection of Nodes;
    // the optional Point argument indicates where the collection of people may have been dropped.
    function assignPeopleToSeats(node, coll, pt) {
        if (isPerson(node)) { // refer to the person's table instead
            node = node.diagram.findNodeForKey(node.data.table);
            if (node === null) return;
        }
        if (coll.any(isTable)) {
            // if dragging a Table, don't allow it to be dropped onto another table
            myDiagram.currentTool.doCancel();
            return;
        }
        // OK -- all Nodes are people, call assignSeat on each person data
        coll.each(function(n) {
            assignSeat(node, n.data, pt);
        });
        positionPeopleAtSeats(node);
    }

    // Given a "Table" Node, assign one guest data to a seat at that table.
    // Also handles cases where the guest represents multiple people, because guest.plus > 0.
    // This tries to assign the unoccupied seat that is closest to the given point in document coordinates.
    function assignSeat(node, guest, pt) {
        if (isPerson(node)) { // refer to the person's table instead
            node = node.diagram.findNodeForKey(node.data.table);
            if (node === null) return;
        }
        if (guest instanceof go.GraphObject) throw Error("A guest object must not be a GraphObject: " + guest.toString());
        if (!(pt instanceof go.Point)) pt = node.location;

        // in case the guest used to be assigned to a different seat, perhaps at a different table
        unassignSeat(guest);

        var model = node.diagram.model;
        var guests = node.data.guests;
        // iterate over all seats in the Node to find one that is not occupied
        var closestseatname = findClosestUnoccupiedSeat(node, pt);
        if (closestseatname) {
            model.setDataProperty(guests, closestseatname, guest.key);
            model.setDataProperty(guest, "table", node.data.key);
            model.setDataProperty(guest, "seat", parseFloat(closestseatname));
        }

        var plus = guest.plus;
        if (plus) { // represents several people
            // forget the "plus" info, since next we create N copies of the node/data
            guest.plus = undefined;
            model.updateTargetBindings(guest);
            for (var i = 0; i < plus; i++) {
                var copy = model.copyNodeData(guest);
                // don't copy the seat assignment of the first person
                copy.table = undefined;
                copy.seat = undefined;
                model.addNodeData(copy);
                assignSeat(node, copy, pt);
            }
        }
    }

    // Declare that the guest represented by the data is no longer assigned to a seat at a table.
    // If the guest had been at a table, the guest is removed from the table's list of guests.
    function unassignSeat(guest) {
        if (guest instanceof go.GraphObject) throw Error("A guest object must not be a GraphObject: " + guest.toString());
        var model = myDiagram.model;
        // remove from any table that the guest is assigned to
        if (guest.table) {
            var table = model.findNodeDataForKey(guest.table);
            if (table) {
                var guests = table.guests;
                if (guests) model.setDataProperty(guests, guest.seat.toString(), undefined);
            }
        }
        model.setDataProperty(guest, "table", undefined);
        model.setDataProperty(guest, "seat", undefined);
    }

    // Find the name of the unoccupied seat that is closest to the given Point.
    // This returns null if no seat is available at this table.
    function findClosestUnoccupiedSeat(node, pt) {
        if (isPerson(node)) { // refer to the person's table instead
            node = node.diagram.findNodeForKey(node.data.table);
            if (node === null) return;
        }
        var guests = node.data.guests;
        var closestseatname = null;
        var closestseatdist = Infinity;
        // iterate over all seats in the Node to find one that is not occupied
        for (var sit = node.elements; sit.next();) {
            var seat = sit.value;
            if (seat.name) {
                var num = parseFloat(seat.name);
                if (isNaN(num)) continue; // not really a "seat"
                if (guests[seat.name]) continue; // already assigned
                var seatloc = seat.getDocumentPoint(go.Spot.Center);
                var seatdist = seatloc.distanceSquaredPoint(pt);
                if (seatdist < closestseatdist) {
                    closestseatdist = seatdist;
                    closestseatname = seat.name;
                }
            }
        }
        return closestseatname;
    }

    // Position the nodes of all of the guests that are seated at this table
    // to be at their corresponding seat elements of the given "Table" Node.
    function positionPeopleAtSeats(node) {
        if (isPerson(node)) { // refer to the person's table instead
            node = node.diagram.findNodeForKey(node.data.table);
            if (node === null) return;
        }
        var guests = node.data.guests;
        var model = node.diagram.model;
        for (var seatname in guests) {
            var guestkey = guests[seatname];
            var guestdata = model.findNodeDataForKey(guestkey);
            positionPersonAtSeat(guestdata);
        }
    }

    // Position a single guest Node to be at the location of the seat to which they are assigned.
    function positionPersonAtSeat(guest) {
        if (guest instanceof go.GraphObject) throw Error("A guest object must not be a GraphObject: " + guest.toString());
        if (!guest || !guest.table || !guest.seat) return;
        var diagram = myDiagram;
        var table = diagram.findPartForKey(guest.table);
        var person = diagram.findPartForData(guest);
        if (table && person) {
            var seat = table.findObject(guest.seat.toString());
            var loc = seat.getDocumentPoint(go.Spot.Center);
            person.location = loc;
        }
    }

    // Automatically drag people Nodes along with the table Node at which they are seated.
    function SpecialDraggingTool() {
        go.DraggingTool.call(this);
        this.isCopyEnabled = false; // don't want to copy people except between Diagrams
    }
    go.Diagram.inherit(SpecialDraggingTool, go.DraggingTool);

    /** @override */
    SpecialDraggingTool.prototype.computeEffectiveCollection = function(parts) {
        var map = go.DraggingTool.prototype.computeEffectiveCollection.call(this, parts);
        // for each Node representing a table, also drag all of the people seated at that table
        parts.each(function(table) {
            if (isPerson(table)) return; // ignore persons
            // this is a table Node, find all people Nodes using the same table key
            for (var nit = table.diagram.nodes; nit.next();) {
                var n = nit.value;
                if (isPerson(n) && n.data.table === table.data.key) {
                    if (!map.contains(n)) map.add(n, {
                        point: n.location.copy()
                    });
                }
            }
        });
        return map;
    };
    // end SpecialDraggingTool


    // Automatically move seated people as a table is rotated, to keep them in their seats.
    // Note that because people are separate Nodes, rotating a table Node means the people Nodes
    // are not rotated, so their names (TextBlocks) remain horizontal.
    function HorizontalTextRotatingTool() {
        go.RotatingTool.call(this);
    }
    go.Diagram.inherit(HorizontalTextRotatingTool, go.RotatingTool);

    /** @override */
    HorizontalTextRotatingTool.prototype.rotate = function(newangle) {
        go.RotatingTool.prototype.rotate.call(this, newangle);
        var node = this.adornedObject.part;
        positionPeopleAtSeats(node);
    };
    // end HorizontalTextRotatingTool

    // $(document).ready(function() {
    // $('#selSeat').multiselect({
    // enableFiltering: true,
    // includeSelectAllOption: true
    // });
    //
    // initData();
    // });

    initData();
    var tbLocation = "0 0";

    function CSeats(total) {
        var seats = [];
        if (total > 0) {
            var p = new go.Point(0, -0.5); // start at top
            var ang = 360 / total; // go clockwise
            for (var i = 0; i < total; i++) {
                seats.push(Seat(i + 1, new go.Spot(p.x + 0.5, p.y + 0.5)));
                p.rotate(ang);
            }
        }
        return seats;
    }

    function getSelectedRadioByName(rdName) {
        var radios = document.getElementsByName(rdName);

        for (var i = 0, length = radios.length; i < length; i++) {
            if (radios[i].checked) {
                return radios[i];
                break;
            }
        }

        return null;
    }

    function RecSeats(total, seatAlign, seatType, seatDistance, bgColorRow) {
        console.log(total);
        console.log(seatAlign);
        console.log(seatType);
        console.log(seatDistance);
        console.log(bgColorRow);

        var seats = [];

        if (total > 0) {
            let px = seatAlign;
            let py = 0;
            let ox = 0;
            let oy = 0;

            switch (seatType) {
                case "1":
                case "2":
                    let o = 1,
                        z = 0;

                    if (seatType === "2") {
                        o = 0;
                        z = 1;
                    }

                    for (var i = 1; i <= total; i++) {
                        if (i % 2 === 0) {
                            seats.push(Seat(i, new go.Spot(px, o, ox, oy), go.Spot.Center, bgColorRow));
                            px = px + seatAlign;
                            ox = ox + seatDistance;
                        } else {
                            seats.push(Seat(i, new go.Spot(px, z, ox, oy), go.Spot.Center, bgColorRow));
                        }
                    }
                    break;
                case "3":
                case "4":
                    if (seatType === "3") py = 1;
                    for (var i = 1; i <= total; i++) {
                        seats.push(Seat(i, new go.Spot(px, py, ox, oy), go.Spot.Center, bgColorRow));
                        px = px + seatAlign;
                        ox = ox + seatDistance;
                    }
                    break;
                case "5":
                case "6":
                    if (seatType === "5") py = 1;

                    for (var i = 1; i <= total; i++) {
                        let sn = i;
                        if (i > 1) sn = i + (i - 1);

                        seats.push(Seat(sn, new go.Spot(px, py, ox, oy), go.Spot.Center, bgColorRow));
                        px = px + seatAlign;
                        ox = ox + seatDistance;
                    }
                    break;
                case "7":
                case "8":
                    if (seatType === "7") py = 1;

                    for (var i = 1; i <= total; i++) {
                        let sn = i + i;

                        seats.push(Seat(sn, new go.Spot(px, py, ox, oy), go.Spot.Center, bgColorRow));
                        px = px + seatAlign;
                        ox = ox + seatDistance;
                    }
                    break;
            }
        }

        return seats;
    }

    class RectangleTable {
        constructor(tbKey, tbName, tbLocation, tbAngle, tbWidth, tbHeight, totalSeat, seatType, seatDistance, bgColorRow) {
            this.tbKey = tbKey;
            this.tbName = tbName;
            this.tbLocation = tbLocation;
            this.tbAngle = tbAngle;
            this.tbWidth = tbWidth;
            this.tbHeight = tbHeight;
            this.totalSeat = totalSeat;
            this.seatType = seatType;
            this.seatDistance = seatDistance;
            this.bgColorRow = bgColorRow;
        }
    }

    function getTables() {
        const tables = [];
        tables.push(new RectangleTable(1, "Line 12A", "486 -38", 90, 488, 40, 12, "3", 5, "#f1afa3"));
        tables.push(new RectangleTable(2, "Line 12B", "404 -38", 90, 488, 40, 12, "8", 5, "#f1afa3"));
        tables.push(new RectangleTable(3, "Line 14", "807 -257", 0, 526, 50, 13, "3", 5, "#efe976"));

        tables.forEach((table, index) => {
            createNewNode(table.tbKey, table.tbName, table.tbLocation, table.tbAngle, table.tbWidth, table.tbHeight, table.totalSeat, table.seatType, table.seatDistance, table.bgColorRow);
        });
    }

    function createTable() {
        const txtLineName = document.getElementById("lineName");
        const txtTotalSeat = document.getElementById("seatTotal");
        const txtSeatDis = document.getElementById("seatDis");
        const txtTbWidth = document.getElementById("tableWidth");
        const txtTbHeight = document.getElementById("tableHeight");
        const seatType = getSelectedRadioByName("seatType");
        const bgColorRow = document.getElementById("bgColorRow").value;
        console.log(bgColorRow);

        if (validateInput(txtLineName) && validateNumber(txtTotalSeat) && validateNumber(txtSeatDis) && seatType && seatType.value) {
            const totalSeat = parseInt(txtTotalSeat.value);
            const tbWidth = parseInt(txtTbWidth.value);
            const tbHeight = parseInt(txtTbHeight.value);
            const seatDistance = parseInt(txtSeatDis.value);

            createNewNode(5, txtLineName.value, tbLocation, 0, tbWidth, tbHeight, totalSeat, seatType.value, seatDistance, bgColorRow);

            jQuery('#createTableModal').modal('hide');
        }

        console.log(myDiagram.model.Ce);
    }

    const TableNameType = "TableOO";
    const TableShape = {
        Rectangle: "Rectangle"
    };

    function createNewNode(tbKey, tbName, tbLocation, tbAngle, tbWidth, tbHeight, totalSeat, seatType, seatDistance, bgColorRow) {
        const seatAlign = 35 / tbWidth;

        myDiagram.nodeTemplateMap.add(TableNameType,
            goJs(go.Node, "Spot", tableStyle(),
                goJs(go.Panel, "Spot",
                    goJs(go.Shape, TableShape.Rectangle, {
                            name: "TABLESHAPE",
                            desiredSize: new go.Size(tbWidth, tbHeight),
                            fill: bgColorRow,
                            stroke: null
                        },
                        new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),
                        new go.Binding("fill")),
                    goJs(go.TextBlock, {
                            editable: true,
                            font: "bold 11pt Verdana, sans-serif"
                        },
                        new go.Binding("text", "name").makeTwoWay(),
                        //new go.Binding("angle", "angle", function(n) { return -n; })
                    )
                    /*goJs("Button", { desiredSize: new go.Size(40, 20), click: function(e, obj){
                        myDiagram.startTransaction("add seat");
                       // you need to figure out the arguments to the Seat function
                       obj.part.add(Seat(9, "1 1", "0 0"));
                       // and you need to figure out if and how to modify the
                       // alignment and alignmentFocus of the other seats
                       myDiagram.commitTransaction("add seat"); 
                    }})*/
                ),
                RecSeats(totalSeat, seatAlign, seatType, seatDistance, bgColorRow)
            ));

        const table = {
            "key": tbKey,
            "category": TableNameType,
            "name": tbName,
            "guests": {},
            "loc": tbLocation,
            "angle": tbAngle
        };

        //myDiagram.startTransaction("Begin adding table transaction");
        myDiagram.model.addNodeData(table);
        //myDiagram.commitTransaction("Commit adding table transaction");
    }

    getTables();

    function DeleteLine() {
        var table = myDiagram.selection.first();
        console.log(table);

        myDiagram.allowDelete = true;
        myDiagram.commandHandler.deleteSelection();
        myDiagram.allowDelete = false;
    }

    function AddSeat() {
        var table = myDiagram.selection.first();
        console.log(table);
        console.log(table.data);
        console.log(table.Ri);
        console.log(table.elements.wc.n);

        if (!(table instanceof go.Node)) return;
        if (table.category == "") return; // must not be a Person
        myDiagram.startTransaction("add seat");
        // need to figure out the arguments to the Seat function
        table.add(Seat(9, "1 1", "0 0"));
        // and need to figure out if and how to modify the
        // alignment and alignmentFocus of the other seats
        myDiagram.commitTransaction("add seat");
    }

    function RemoveSeat() {
        var table = myDiagram.selection.first();

        if (table) {
            table.removeAt(2);
        } else {
            return;
        }

        console.log(table);
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function validateInput(e) {
        if (e.value && e.value != "") {
            e.classList.remove("required-border");
            return true;
        } else {
            e.classList.add("required-border");
            return false;
        }
    }

    function validateNumber(e) {
        const v = e.value;
        if (v && v != "" && Number.isInteger(parseInt(v)) && parseInt(v) > 0) {
            e.classList.remove("required-border");
            return true;
        } else {
            e.classList.add("required-border");
            return false;
        }
    }

    function openDelSeatModal() {
        var optionSeats = [];
        var table = myDiagram.selection.first();

        if (table) {
            const seats = table.elements.wc.n;
            for (let s of seats) {
                if (s.Sb && s.Sb !== "") {
                    let o = s.Sb.toString();
                    let option = {
                        label: o,
                        title: o,
                        value: o
                    };
                    optionSeats.push(option);
                }
            }
            $('#selSeat').multiselect('dataprovider', optionSeats);
        } else {
            return;
        }
    }

    function delSeat() {
        var table = myDiagram.selection.first();
        if (table) {
            const seats = table.elements.wc.n;
            var selectedOptions = $('#selSeat option:selected');
            selectedOptions.each(function() {
                let s = $(this).val();
                myDiagram.startTransaction("delete seat");
                table.removeAt(s);
                myDiagram.commitTransaction("delete seat");
            });

            $('#delSeatModal').modal('hide');
        }
    }

    function calculateTableWidth(e) {
        if (!e.checked) return;
        const txtTotalSeat = document.getElementById("seatTotal");
        const txtSeatDis = document.getElementById("seatDis");

        if (txtTotalSeat.value === "") {
            alert("Please input total seat");
            e.checked = false;
            return;
        }
        if (txtSeatDis.value === "") {
            alert("Please input seat distance");
            e.checked = false;
            return;
        }

        let totalSeat = parseInt(txtTotalSeat.value);
        const seatDistance = parseInt(txtSeatDis.value);
        const seatType = getSelectedRadioByName("seatType");

        if (seatType === undefined || seatType === null) {
            alert("Please select Seat Type");
            e.checked = false;
            return;
        }

        let tableWidth = (totalSeat * 35) + (txtSeatDis.value * (totalSeat - 1)) + 35;
        let haftWidth = Math.floor(tableWidth / 2);

        switch (seatType.value) {
            case "1":
            case "2":
                haftWidth = totalSeat % 2 === 1 ? haftWidth + 35 : haftWidth + 15;
                document.getElementById("tableWidth").value = haftWidth;
                validateInput(widthElement);
                break;
            default:
                document.getElementById("tableWidth").value = tableWidth;
                validateInput(widthElement);
                break;
        }
    }

    const widthElement = document.getElementById("tableWidth");

    function showCreateRowModal() {
        validateInput(widthElement);
    }

</script>

</html>
